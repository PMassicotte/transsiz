---
title: "Transsiz primary production"
output: 
      md_document: default
---

```{r setup, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(extrafont)
library(tidyverse)

## Set default ggplot2 font size and font familly

loadfonts(quiet = TRUE)
theme_set(theme_bw(base_size = 12, base_family = "IBM Plex Sans"))
```

# Transsiz

This simple report give an overview of the data and procedures used to estimate daily primary production. Primary production was calculated using PAR data from the pyranometer and light transmittance measured by:

1. SUIT
2. ROV

## Pyranometer

This graphic shows hourly averaged pyranometer data.

```{r}
pyrano <- read_csv("data/clean/pyranometer.csv")

pyrano %>%
  ggplot(aes(x = hour, y = par_just_below_surface_Âµmol)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ station) +
  scale_y_continuous(breaks = seq(200, 1500, by = 200))
```

## ROV data

- Transmittance files used: `rovT_irrad`.
- Observations with `pitch` and `roll` between -10 and 10 degrees were kept.
- Ice thickness was estimated as: *ice_thickness = depth_water_m - dist_sea_ice_bottom_m*
- Using each transmittance measurement, PAR0- (measured by the pyranometer) was propagated in the water column. 

\begin{figure}[H]
\includegraphics{graphs/rov_transmittance_histogram.pdf}
\end{figure}

## SUIT data

- Transmittance files used: `Ir_Dist_draft01_b.dat`.
- Depth of measurement (draft) was assumed to reflect the transmittance just below ice (i.e. transmittance_ed0).
- Only haul number was specified in transmittance files. Station id was matched with the file `Summary_file_PS92.txt`.
- Lat/long were extracted in files like `Lat_lon_01.dat` where the last part of the file name reflects the haul number.
- Using each transmittance measurement, PAR0- (measured by the pyranometer) was propagated in the water column. 

\begin{figure}[H]
\includegraphics{graphs/suit_transmittance_histogram.pdf}
\end{figure}

## Matching SUIT and ROV transmittance data

There was some ROV stations without matching SUIT measurements. After discussions, we came up with this table that links stations together.

| ROV 	| SUIT    	|                                           	|
|-----	|---------	|-------------------------------------------	|
| 19  	| 19      	|                                           	|
| 27  	| 27      	|                                           	|
| 31  	| **28**  	| No match, so use a different SUIT station 	|
| 32  	|         	| We forget this station                    	|
| 39  	| 39      	|                                           	|
| 43  	| 43      	|                                           	|
| 46  	| **45**  	| No match, so use a different SUIT station 	|
| 47  	| 47      	|                                           	|

**For this study, we will use a total of seven stations 19, 27, 31, 39, 43, 46, 47.**

## Kd

Kd were calculated using vertical profiles made by the ROV at each station. Calculated Kd are used to propagate pyranomater light using both ROV and SUIT transmittance data.

\begin{figure}[H]
\includegraphics{graphs/rov_vs_depth.pdf}
\end{figure}

\begin{figure}[H]
\includegraphics{graphs/rov_kd.pdf}
\end{figure}

## Propagating light in the water column

With both ROV and SUIT transmittance estimated just under the ice, PAR0- was propagated in the water column using the flowing equation:

\begin{equation}
\text{edz} = \text{par\_just\_below\_surface\_umol} \times e^{(-\text{kd} * \text{depth})} \times \text{transmittance\_percent\_ed0}
\end{equation}

Where $\text{par\_just\_below\_surface\_umol}$ is the irradiance measured by the pyranomater at 0-.

```{r}
suit <- feather::read_feather("data/clean/suit_propagated_par_water_column.feather") %>%
  slice(1:384)

suit %>%
  ggplot(aes(x = par_z, y = depth, color = factor(hour))) +
  geom_path() +
  scale_y_reverse() +
  labs(color = "Hours") +
  labs(title = "Hourly PAR profiles associated to 1 SUIT transmittance measurment") +
  theme(text = element_text(size = 10))
```


## Photosynthetic parameters (PvsE curves)

Photosynthetic parameters have been determined from the P vs E curves obtained according to a method derived from Lewis and Smith (1983) both on water samples taken from the rosette and ice core bottom (last cm, see an example in Fig. \ref{fig:pvse}). Some samples were also collected directly under the ice (UISW). 

\begin{figure}[H]
\centering
\includegraphics[page = 57]{graphs/pe_curves.pdf}
\caption{Example of a fitted PvsE curve.}
\label{fig:pvse}
\end{figure}

Two different models based on the original definition proposed by (Platt et al., 1980) were used depending on the situation.

### Model with photoinhibition

When apparent photo-inhibition was present, a model including two exponential was fitted (equation \ref{eq:two_exp}).

\begin{equation}
p = ps \times (1 - e^{-\alpha \times \frac{light}{ps}}) \times e^{-\beta \times \frac{light}{ps}} + p0
\label{eq:two_exp}
\end{equation}

### Model without photoinhibition

When no apparent photo-inhibition was present, a model including only one exponential was fitted (equation \ref{eq:one_exp}).

\begin{equation}
p = ps \times (1 - e^{-\alpha \times \frac{light}{ps}}) + p0
\label{eq:one_exp}
\end{equation}

Finally, photosynthetic parameters have been interpolated between 0 and 15 m at 1 m increment.

\begin{figure}[H]
\includegraphics{graphs/pvse_propagated_parameters.pdf}
\caption{Propagated PvsE parameters in the water column.}
\label{fig:pvse_params}
\end{figure}

## Primary production

Daily primary production at each depth at each hour was calculated using equation \ref{eq:pp}.

\begin{equation}
p = ps \times (1 - e^{-\alpha \times \frac{light}{ps}})
\label{eq:pp}
\end{equation}

```{r}
pp <- feather::read_feather("data/clean/primary_production_rov_vs_suit.feather")

n <- pp %>%
  group_by(station, data_source) %>%
  tally()

knitr::kable(n, caption = "Number of primary production profiles generated by combining pyranometer and SUIT/ROV data.")
```

The following graphs combine a total of `r sum(n$n)` estimations of primary production.

\begin{figure}[H]
\includegraphics{graphs/primary_production_rov_vs_suit.pdf}
\caption{Depth/daily integrated primary production.}
\label{fig:pvse_params}
\end{figure}

```{r}
pp %>%
  filter(daily_integrated_pp > 0) %>%
  group_by(station, data_source) %>%
  summarise(mean_pp = mean(daily_integrated_pp)) %>%
  # spread(data_source, mean_pp) %>%
  knitr::kable()
```



